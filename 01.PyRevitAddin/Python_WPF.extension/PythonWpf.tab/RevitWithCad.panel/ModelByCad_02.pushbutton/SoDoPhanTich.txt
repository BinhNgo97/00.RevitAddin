                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚   CAD DATA    â”‚
                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                      â”‚ circle        â”‚
                                      â”‚ line          â”‚
                                      â”‚ polyline      â”‚
                                      â”‚ text          â”‚
                                      â”‚ ...           â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  Data cleaned after    â”‚
                                â”‚  ruler (phi hÃ¬nh há»c)  â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ B1: PhÃ¢n tÃ­ch khÃ©p kÃ­n   â”‚
                             â”‚ hÃ¬nh há»c cá»§a element     â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â–¼                                             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Closed (line/poly/   â”‚                    â”‚ Open (line/poly/arc) â”‚
      â”‚ circle/arc)          â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
                 â”‚                                           â–¼
                 â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                â”‚ B2: Merge element â”‚
                 â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                           â”‚
                 â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                              â”‚ CÃ¡c element sau merge   â”‚
                 â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                           â”‚
                 â”‚                                           â–¼
                 â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚ B3: Gom nhÃ³m cÃ¹ng phÆ°Æ¡ng    â”‚
                 â”‚                          â”‚ (song song)                 â”‚
                 â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                       â”‚
                 â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â–¼                â–¼                â–¼
                 â”‚                    [TH1]            [TH2]            [TH3]
                 â”‚                                       â”‚
                 â”‚                                       â–¼
                 â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                           â”‚ CÃ¡c cáº·p 1 vs 1     â”‚
                 â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                       â”‚
                 â”‚                                       â–¼
                 â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                           â”‚ Bounding Box total â”‚
                 â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                       â”‚
                 â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â–¼                                 â–¼
                 â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚            â”‚ Dáº§m biÃªn         â”‚             â”‚ Dáº§m giá»¯a         â”‚
                 â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                     â”‚                                  â”‚
                 â”‚                     â–¼                                  â–¼
                 â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚        â”‚ Láº¥y nÃ©t ngoÃ i cÃ¹ng     â”‚        â”‚ Láº¥y tim cáº·p Ä‘Æ°á»ng      â”‚
                 â”‚        â”‚ lÃ m location line      â”‚        â”‚ lÃ m location line      â”‚
                 â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                     â”‚                                  â”‚
                 â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                    â–¼
                 â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚ Location line      â”‚
                 â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                     â”‚
                 â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â–¼                             â–¼
                 â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚        â”‚ CÃ³ text láº¥y b x h      â”‚     â”‚ KhÃ´ng cÃ³ text          â”‚
                 â”‚        â”‚ FRM: bxh (30x60)       â”‚     â”‚ FRM: 30xh              â”‚
                 â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Cho cá»™t, mÃ³ng       â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ Láº¥y kÃ­ch thÆ°á»›c      â”‚
      â”‚ chá»©a hÃ¬nh há»c       â”‚
      â”‚ Format: CLN b x h   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Discription

INPUT
â”‚
â”œâ”€â”€ CAD DATA
â”‚     â”œâ”€â”€ line
â”‚     â”œâ”€â”€ polyline
â”‚     â”œâ”€â”€ circle
â”‚     â”œâ”€â”€ arc
â”‚     â””â”€â”€ text
â”‚
â””â”€â”€ USER RULER
      â”œâ”€â”€ Layer filter
      â”œâ”€â”€ Geometry filter
      â”œâ”€â”€ Merge rule
      â”œâ”€â”€ min_d
      â”œâ”€â”€ max_d
      â””â”€â”€ min_length = 1000
============================================================

STEP 1: CLEAN DATA
â”‚
â””â”€â”€ Filter theo Layer + Geometry
      â†“
   CLEANED DATA

============================================================
STEP 2: PHÃ‚N TÃCH KHÃ‰P KÃN (B1)
â”‚
â”œâ”€â”€ CLOSED ELEMENT ?
â”‚     â”‚
â”‚     â””â”€â”€ YES â†’ (Cá»™t / MÃ³ng)
â”‚              â”œâ”€â”€ Láº¥y Bounding Box
â”‚              â”œâ”€â”€ TÃ­nh b, h
â”‚              â””â”€â”€ Format: CLN: b x h
â”‚
â””â”€â”€ NO (OPEN ELEMENT)
        â†“
      (Dáº§m)
============================================================
STEP 3: MERGE OPEN ELEMENT (B2)
â”‚
â””â”€â”€ Apply Merge Rule
        â†“
    MERGED ELEMENTS
        â†“
    Filter: length >= 1000
============================================================

STEP 4: GOM NHÃ“M SONG SONG (B3)
â”‚
â””â”€â”€ Group by direction (Parallel)
        â”‚
        â”œâ”€â”€ TH1
        â”œâ”€â”€ TH2
        â”œâ”€â”€ TH3
        â””â”€â”€ ...
============================================================        
STEP 5: Táº O Cáº¶P 1 VS 1
â”‚
â””â”€â”€ Vá»›i má»—i group:
        â”‚
        â”œâ”€â”€ TÃ­nh khoáº£ng cÃ¡ch d
        â”‚
        â”œâ”€â”€ Náº¿u min_d <= d <= max_d
        â”‚        â†’ Táº¡o PAIR
        â”‚
        â””â”€â”€ Bá» náº¿u khÃ´ng Ä‘áº¡t
============================================================      
STEP 6: XÃC Äá»ŠNH LOáº I Dáº¦M
â”‚
â”œâ”€â”€ Náº¿u cáº·p ngoÃ i cÃ¹ng Bounding Box
â”‚        â†’ Dáº¦M BIÃŠN
â”‚           â””â”€â”€ Location line = nÃ©t ngoÃ i cÃ¹ng
â”‚
â””â”€â”€ Náº¿u cáº·p á»Ÿ giá»¯a
         â†’ Dáº¦M GIá»®A
            â””â”€â”€ Location line = tim cáº·p Ä‘Æ°á»ng
============================================================      
STEP 7: Xá»¬ LÃ TEXT
â”‚
â”œâ”€â”€ CÃ³ text gáº§n cáº·p?
â”‚       â”‚
â”‚       â”œâ”€â”€ YES â†’ Parse b x h
â”‚       â”‚        Format: (30x60)
â”‚       â”‚
â”‚       â””â”€â”€ NO  â†’ Format máº·c Ä‘á»‹nh: 30xh
============================================================      
OUTPUT
â”‚
â”œâ”€â”€ COLUMN DATA
â”‚     â”œâ”€â”€ BBox
â”‚     â””â”€â”€ Size: b x h
â”‚
â””â”€â”€ BEAM DATA
      â”œâ”€â”€ Location line
      â”œâ”€â”€ Type: Edge / Middle
      â””â”€â”€ Size: b x h

============================================================      

PHÆ¯Æ NG PHÃP, SÆ  Äá»’ TÆ¯ DUY Äá»‚ Xá»¬ LÃ á»ž STEP 4


ðŸ§  TÆ¯ DUY Cá»T LÃ•I

Dáº§m =
2 cá»¥m line song song ká» nhau

khoáº£ng cÃ¡ch há»£p lá»‡

cÃ³ overlap thá»±c sá»± Ä‘á»§ lá»›n

ðŸ“ SÆ  Äá»’ Tá»”NG QUÃT (ASCII FLOW)
INPUT: Lines (Ä‘Ã£ filter layer, loáº¡i closed, min_length thÃ´)

â”‚
â”œâ”€â”€ STEP 1: Chuáº©n hÃ³a hÃ¬nh há»c
â”‚       - Chuáº©n hÃ³a direction vector
â”‚       - Project vá» trá»¥c 1D (param start/end)
â”‚       - TÃ­nh offset vuÃ´ng gÃ³c
â”‚
â”œâ”€â”€ STEP 2: Group theo hÆ°á»›ng song song
â”‚       group by direction (Â± angle tolerance)
â”‚
â”œâ”€â”€ STEP 3: Vá»›i má»—i parallel_group:
â”‚
â”‚       â”œâ”€â”€ 3.1 Cluster theo offset
â”‚       â”‚       if |offset_i - offset_j| â‰¤ offset_tol
â”‚       â”‚       â†’ cÃ¹ng cluster
â”‚       â”‚
â”‚       â”œâ”€â”€ 3.2 Merge collinear trong tá»«ng cluster
â”‚       â”‚       - Sort theo start_param
â”‚       â”‚       - Merge náº¿u:
â”‚       â”‚             overlap > 0
â”‚       â”‚          OR gap < merge_tol
â”‚       â”‚
â”‚       â”œâ”€â”€ 3.3 Sau merge:
â”‚       â”‚       Má»—i cluster = 1 hoáº·c vÃ i segment Ä‘áº¡i diá»‡n
â”‚       â”‚
â”‚       â”œâ”€â”€ 3.4 Sort cluster theo offset tÄƒng dáº§n
â”‚       â”‚
â”‚       â”œâ”€â”€ 3.5 Pair chá»‰ cluster ká» nhau:
â”‚       â”‚
â”‚       â”‚       for i = 1 â†’ k-1:
â”‚       â”‚           C1 = cluster[i]
â”‚       â”‚           C2 = cluster[i+1]
â”‚       â”‚
â”‚       â”‚           d = |offset(C1) - offset(C2)|
â”‚       â”‚
â”‚       â”‚           if min_d â‰¤ d â‰¤ max_d:
â”‚       â”‚               â†’ kiá»ƒm tra overlap
â”‚       â”‚
â”‚       â”œâ”€â”€ 3.6 Compute overlap:
â”‚       â”‚
â”‚       â”‚       overlap_start = max(start1, start2)
â”‚       â”‚       overlap_end   = min(end1, end2)
â”‚       â”‚       overlap_len   = overlap_end - overlap_start
â”‚       â”‚
â”‚       â”‚       if overlap_len â‰¥ min_overlap:
â”‚       â”‚           â†’ táº¡o beam
â”‚       â”‚       else:
â”‚       â”‚           â†’ bá»
â”‚
â”‚       â”œâ”€â”€ 3.7 Táº¡o Beam:
â”‚       â”‚
â”‚       â”‚       beam_length = overlap_len
â”‚       â”‚
â”‚       â”‚       if cluster lÃ  ngoÃ i cÃ¹ng:
â”‚       â”‚           â†’ Dáº¦M BIÃŠN
â”‚       â”‚           location_line = outer_line trimmed by overlap
â”‚       â”‚
â”‚       â”‚       else:
â”‚       â”‚           â†’ Dáº¦M GIá»®A
â”‚       â”‚           location_line = center_line trimmed by overlap
â”‚
â””â”€â”€ OUTPUT: Beam list
ðŸ” GIáº¢I THÃCH CÃCH THUáº¬T TOÃN Xá»¬ LÃ Tá»ªNG TH
âœ… TH1 â€“ Äoáº¡n rá»i ráº¡c cÃ¹ng mÃ©p

Cluster gom cÃ¹ng offset

Merge thÃ nh 1 line

Pair bÃ¬nh thÆ°á»ng

â†’ Káº¿t quáº£: 1 beam Ä‘Ãºng

âœ… TH2 â€“ 1 dÃ i + nhiá»u ngáº¯n

Sau cluster:

C1 (ngáº¯n)
C2 (dÃ i)
C3 (ngáº¯n)

Pair ká» nhau:

(C1,C2)
(C2,C3)

Overlap tá»«ng cáº·p riÃªng

â†’ Táº¡o 2 beam Ä‘á»™c láº­p
â†’ KhÃ´ng chá»“ng láº¯p náº¿u merge Ä‘Ãºng

âœ… TH3 â€“ Nhiá»u line dÃ i song song
C1
C2
C3
C4

Pair:

(C1,C2)
(C2,C3)
(C3,C4)

â†’ Táº¡o Ä‘Ãºng sá»‘ dáº§m thá»±c táº¿
â†’ KhÃ´ng pair chÃ©o

âœ… TH4 â€“ Hai phÃ­a Ä‘á»u chia Ä‘oáº¡n

Cluster:

Cluster A: A1,A2,A3
Cluster B: B1,B2

Merge:

A_merged
B_merged

Pair 1 láº§n

â†’ Táº¡o 1 beam duy nháº¥t

âœ… TH5 â€“ ÄÆ°á»ng gáº§n nhau nhÆ°ng khÃ´ng overlap

Khoáº£ng cÃ¡ch offset OK
NhÆ°ng:

overlap_len â‰¤ 0

â†’ KhÃ´ng táº¡o beam

TrÃ¡nh dáº§m giáº£.

âœ… TH6 â€“ Hai Ä‘oáº¡n ngáº¯n overlap má»™t pháº§n nhá»

Sau merge cluster:

L_short_merged
L_long

TÃ­nh overlap tháº­t sá»±:

beam_length = overlap_len

Náº¿u overlap nhá» hÆ¡n ngÆ°á»¡ng:

â†’ bá»

Náº¿u Ä‘á»§ lá»›n:

â†’ táº¡o 1 beam duy nháº¥t
â†’ location line bá»‹ trim theo overlap

ðŸŽ¯ ÄIá»‚M QUAN TRá»ŒNG NHáº¤T Cá»¦A TOÃ€N Bá»˜ Há»†

Thá»© tá»± báº¯t buá»™c:

Cluster
    â†“
Merge
    â†“
Pair ká» nhau
    â†“
Kiá»ƒm tra khoáº£ng cÃ¡ch
    â†“
Kiá»ƒm tra overlap
    â†“
Táº¡o beam

Sai thá»© tá»± = sinh lá»—i TH2 / TH4 / TH6 ngay láº­p tá»©c.

âš™ï¸ CÃ¡c tham sá»‘ cáº§n thiáº¿t
Tham sá»‘	Vai trÃ²
angle_tol	gom song song
offset_tol	gom cÃ¹ng mÃ©p
merge_tol	ná»‘i Ä‘oáº¡n há»Ÿ nhá»
min_d	khoáº£ng cÃ¡ch dáº§m nhá» nháº¥t
max_d	khoáº£ng cÃ¡ch dáº§m lá»›n nháº¥t
min_overlap	loáº¡i giao nhá» (nhiá»…u)
ðŸ“Š Äá»™ á»•n Ä‘á»‹nh

Thuáº­t toÃ¡n nÃ y:

Xá»­ lÃ½ Ä‘Ãºng 80â€“90% báº£n váº½ kiáº¿n trÃºc chuáº©n

KhÃ´ng cáº§n hard-code theo â€œtrÆ°á»ng há»£pâ€

Äá»™ phá»©c táº¡p: O(n log n)
